# REDCap XML Parser and Snowflake Uploader

This directory contains two scripts for processing REDCap XML data and uploading it to Snowflake:

1. `redcap_xml_parser.py`: Parses REDCap XML data and generates TSV files
2. `upload_csv_to_snowflake.py`: Uploads the TSV files to Snowflake

## REDCap XML Parser

The `redcap_xml_parser.py` script processes REDCap XML data files and performs several key operations:
1. Parses XML data using xmltodict and ElementTree
2. Extracts schema information from the XML
3. Builds a schema dictionary with table and column details
4. Creates a decoding dictionary for coded values
5. Processes the actual clinical data from the XML
6. Generates table records with decoded values where applicable
7. Saves the results as TSV files

### Usage

```bash
python redcap_xml_parser.py --file <path_to_xml_file> --output <output_directory>
```

#### Arguments

- `--file`, `-f`: Path to the REDCap XML file. Can be a local file or an S3 URL (s3://bucket/path/to/file)
- `--output`, `-o`: Directory to save output TSV files (default: 'output')

### Output Files

The script generates the following TSV files:
- `schema.tsv`: Contains schema information for all tables, including Snowflake data types
- `decoding.tsv`: Contains decoding information for coded values
- `<table_name>.tsv`: One file for each table in the data

## Snowflake Uploader

The `upload_csv_to_snowflake.py` script reads TSV files generated by `redcap_xml_parser.py` and uploads them to Snowflake. It performs the following operations:
1. Reads the schema TSV file to understand the table structure
2. Compares the schema with existing Snowflake tables
3. Creates or updates tables as needed
4. Uploads the data from the table content TSV files to Snowflake

### Usage

```bash
python upload_csv_to_snowflake.py --input-dir <input_directory> --account <snowflake_account> --user <snowflake_user> --password <snowflake_password> --warehouse <snowflake_warehouse> --database <snowflake_database> --schema <snowflake_schema> [--role <snowflake_role>] [--mode <upload_mode>] [--ignore-schema-differences]
```

#### Arguments

- `--input-dir`, `-i`: Directory containing the TSV files
- `--account`: Snowflake account name
- `--user`: Snowflake username
- `--password`: Snowflake password
- `--warehouse`: Snowflake warehouse name
- `--database`: Snowflake database name
- `--schema`: Snowflake schema name
- `--role`: Snowflake role name (optional)
- `--mode`: Upload mode: append or replace (default: replace)
- `--ignore-schema-differences`: Ignore schema differences and proceed with upload

## Workflow

The typical workflow is as follows:

1. Run `redcap_xml_parser.py` to process the REDCap XML file and generate TSV files:
   ```bash
   # For local files:
   python redcap_xml_parser.py --file path/to/redcap_data.xml --output output_dir

   # For S3 files:
   python redcap_xml_parser.py --file s3://bucket-name/path/to/redcap_data.xml --output output_dir
   ```

2. Run `upload_csv_to_snowflake.py` to upload the TSV files to Snowflake:
   ```bash
   python upload_csv_to_snowflake.py --input-dir output_dir --account <account> --user <user> --password <password> --warehouse <warehouse> --database <database> --schema <schema>
   ```

## Requirements

- Python 3.6+
- pandas
- xmltodict
- boto3 (for S3 support)
- snowflake-connector-python (for Snowflake support)
